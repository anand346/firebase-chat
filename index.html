<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <meta name="Description" content="Chat application" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <link rel="stylesheet" href="assets/css/style.css" />
    <title>Title</title>
    <style>
      .chat-list{
        scrollbar-width: none;
      }
    </style>
  </head>
  <body>
    <div class="container content flex-column align-items-start h-100">
      <div class="row w-100 mb-2" style="display:flex;justify-content:flex-end;padding-right:20px;">
        <button class="btn btn-primary logout" type="button">Log Out</button>
      </div>
      <div class="row w-100" style="height:500px;">
        <div class="col-xl-4 col-lg-4 col-md-4 col-sm-12 col-12 mb-3 contactList" >
            <div class="card w-100 h-100">
                <div class="top">
                    <h4 class="mt-2">Inbox</h4>
                </div>
                <div class="bottom">
                    <div class="d-flex justify-content-between align-items-center mb-3 individual">
                        <div class="d-flex flex-row align-items-center">
                            <div class="image"> <img src="https://bootdey.com/img/Content/avatar/avatar1.png" width="48">  </div>
                            <div class="d-flex flex-column line-height ml-2"> <span class="font-weight-bold">hannahdat21</span> <span>Can i order online?</span>  </div>
                        </div> <span class="dots"> </span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-3 individual">
                        <div class="d-flex flex-row align-items-center">
                            <div class="image"> <img src="https://bootdey.com/img/Content/avatar/avatar2.png" width="48"> </div>
                            <div class="d-flex flex-column line-height ml-2"> <span class="font-weight-bold">hannahdat21</span> <span>Is this still available?</span></div>
                        </div> <span class="dots"> </span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-3 individual">
                        <div class="d-flex flex-row align-items-center">
                            <div class="image"> <img src="https://bootdey.com/img/Content/avatar/avatar3.png" width="48">  </div>
                            <div class="d-flex flex-column line-height ml-2"> <span class="font-weight-bold">hannahdat21</span> <span>Thanks hannah!</span> </div>
                        </div> <span class="dots"> </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-8 col-lg-8 col-md-8 col-sm-12 col-12 mb-3 chatScreen">
          <div class="card w-100 " style = "height:485px;">
            <div class="card-header">
              <i class="fas fa-arrow-left" style = "margin-right:10px;"></i>
              Chat
            </div>
            <div class="card-body height3" style = "height:100%">
              <ul class="chat-list" style = "height:100%;overflow:scroll;">
                <li class="in">
                  <div class="chat-img">
                    <img
                      alt="Avtar"
                      src="https://bootdey.com/img/Content/avatar/avatar1.png"
                    />
                  </div>
                  <div class="chat-body">
                    <div class="chat-message">
                      <h5>Jimmy Willams</h5>
                      <p>Raw denim heard of them tofu master cleanse</p>
                    </div>
                  </div>
                </li>
                <li class="out">
                  <div class="chat-body">
                    <div class="chat-message">
                      <h5>Serena</h5>
                      <p>Next level veard</p>
                    </div>
                  </div>
                  <div class="chat-img">
                    <img
                      alt="Avtar"
                      src="https://bootdey.com/img/Content/avatar/avatar6.png"
                    />
                  </div>
                  
                </li>
                <li class="in">
                  <div class="chat-body">
                    <div class="chat-message">
                      <p>Will stumptown scenes coffee viral.</p>
                    </div>
                  </div>
                </li>
                <li class="out">
                  <div class="chat-body">
                    <div class="chat-message">
                      <p>Tofu master best deal</p>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
            <div class="chat-message clearfix">
              <div class="input-group mb-0">
                  <div class="input-group-prepend">
                    <span class="input-group-text emojiButton"><i class="fa fa-smile"></i></span>
                  </div>
                  <input type="text" class="form-control messageInput" placeholder="Enter text here...">                                    
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fa fa-paper-plane"></i></span>
                  </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/md5.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/emoji-button@latest/dist/index.min.js"></script>
    <script src =  "assets/js/firebase.js"></script>
    <script>
      if(sessionStorage.getItem("authUser") == null){
        $(".container").html("");
        window.location.href = "login.html";
      }else{
        
        //emoji starts

        const picker = new EmojiButton({
          position: 'top-start'
        });
        const trigger = $('.emojiButton');
        picker.on('emoji', function(emoji) {
          var val = $(".messageInput").val();
          $(".messageInput").val(val + emoji);
          pikcer.pickerVisible = true;
        });
        trigger.on('click', function() {
          picker.pickerVisible ? picker.hidePicker() : picker.showPicker(trigger);
        });

        //emoji ends

        
        //basic variables starts --

        const database = firebase.database();
        const usersCollection = database.ref("/users");
        const msgsCollection = database.ref("/msgs");
        var myId = sessionStorage.getItem("authUser");
        $(".chat-list").html("");
        $(".bottom").html("");

        //basic variables starts --


        //function for sending message starts -- 

        function sendMessage(){
          var message = $(".messageInput").val();
          $(".messageInput").val("");
          var username = "";
          usersCollection.child(myId).on("value",(snapshot) => {
            username = snapshot.val().username;
          })
          var msg = {
            from : myId,
            username : username,
            text : message,
            time : new Date().getTime()
          }
          msgsCollection.push().set(msg);
        }
        
        //function for sending message ends --


        //function for checking whether this message is sent by me or not starts --

        function checkMsg(msg){
          if(msg.from == myId){
            return `
                  <li class="out">
                    <div class="chat-body">
                      <div class="chat-message">
                        <h5>${msg.username}</h5>
                        <p>${msg.text}</p>
                      </div>
                    </div>
                  </li>
            `
          }else{
            return `
                  <li class="in">
                    <div class="chat-body">
                      <div class="chat-message">
                        <h5>${msg.username}</h5>
                        <p>${msg.text}</p>
                      </div>
                    </div>
                  </li>

            `
          }
        }

        //function for checking whether this message is sent by me or not ends --


        //retrieving all users once when page loads starts --

        usersCollection.on('child_added',(snapshot) =>{
            if(!(snapshot.key == sessionStorage.getItem("authUser"))){
              $(".bottom").append(`
                <div class="d-flex justify-content-between align-items-center mb-3 individual" data-id = ${snapshot.key} >
                    <div class="d-flex flex-row align-items-center">
                        <div class="image"> <img src="https://www.gravatar.com/avatar/${CryptoJS.MD5(snapshot.val().email)}?d=robohash" width="48">  </div>
                        <div class="d-flex flex-column line-height ml-2"> <span class="font-weight-bold">${snapshot.val().username}</span> </div>
                    </div> ${snapshot.val().status == 'online' ? '<span class="onlinedot">' : '<span class="offlinedot">'} </span>
                </div>
                <hr>
              `)
            }
        })
        
        //retrieving all users once when page loads ends --


        //checking whether user is online or not at realtime starts --

        usersCollection.on('child_changed',(snapshot) =>{
            if(!(snapshot.key == sessionStorage.getItem("authUser"))){
              $(".individual").each(function(){
                if($(this).data("id") == snapshot.key){
                  $(this).html(`
                      <div class="d-flex flex-row align-items-center">
                          <div class="image"> <img src="https://www.gravatar.com/avatar/${CryptoJS.MD5(snapshot.val().email)}?d=robohash" width="48">  </div>
                          <div class="d-flex flex-column line-height ml-2"> <span class="font-weight-bold">${snapshot.val().display_name}</span> <span>Can i order online?</span>  </div>
                      </div> ${snapshot.val().status == 'online' ? '<span class="onlinedot">' : '<span class="offlinedot">'} </span>  
                  `)
                }
              })
            }
        })
        
        //checking whether user is online or not at realtime ends --


        //retrieving messages at realtime starts --

        msgsCollection.on("child_added",(snapshot) =>{
            $(".chat-list").append(`
              ${checkMsg(snapshot.val())}
            `)
            var chat_list = document.querySelector(".chat-list");
            chat_list.scrollTop = chat_list.scrollHeight;
        })

        //retrieving messages at realtime ends --


        //sending message on enter key press starts --

        $('.messageInput').keypress(function(event){	
          var keycode = (event.keyCode ? event.keyCode : event.which);
          if(keycode == '13'){
            sendMessage();
          }
        });

        //sending message on enter key press ends --


        //sending message on paper plane click starts --

        $(".fa-paper-plane").on("click",function(){
          sendMessage();
        })

        //sending message on paper plane click ends --


        //logout button coding  starts --

        $(".logout").on("click",function(){
          usersCollection.child(myId).update({
            status : 'offline'
          })
          sessionStorage.setItem("authUser",null);
          window.location.href = "login.html";
        })

        //logout button coding  ends --
      }
        
      </script>
  </body>
</html>
